{
  "hash": "773c90518b68dd2648a9607ae13a54ae",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"edsa - buisness2\"\nauthor: \"Goh Si Hui\"\ndate: \"Oct 26 2024\"\ndate-modified: \"last-modified\"\nexecute: \n  eval: true\n  echo: true\n  message: false\n  warning: false\n  freeze: true\n  code-line-numbers: true\n---\n\n\n\n\n\n\n\n\n\n\n# Setting the environment \n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\npacman::p_load(tidyverse, purrr, sf, tmap, sfdep)\n```\n:::\n\n\n\n\n\n\n\n\n\n\n# Importing Datasets \n\n## Business data \n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nbusiness <- read_rds(\"data/rds/biz.rds\")\nglimpse(business)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 570,182\nColumns: 4\n$ postal_code <chr> \"018935\", \"018935\", \"018935\", \"018936\", \"018936\", \"018936\"…\n$ uen         <chr> \"201817714D\", \"201316793Z\", \"201933792W\", \"202028573K\", \"2…\n$ latitude    <dbl> 1.277372, 1.277372, 1.277372, 1.277906, 1.277906, 1.277906…\n$ longitude   <dbl> 103.8528, 103.8528, 103.8528, 103.8529, 103.8529, 103.8529…\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nbusiness_sf <- read_rds(\"data/rds/biz_sf.rds\")\nglimpse(business_sf)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 570,182\nColumns: 3\n$ postal_code <chr> \"018935\", \"018935\", \"018935\", \"018936\", \"018936\", \"018936\"…\n$ uen         <chr> \"201817714D\", \"201316793Z\", \"201933792W\", \"202028573K\", \"2…\n$ geometry    <POINT [m]> POINT (30173.11 28870.87), POINT (30173.11 28870.87)…\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nst_crs(business_sf)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCoordinate Reference System:\n  User input: EPSG:3414 \n  wkt:\nPROJCRS[\"SVY21 / Singapore TM\",\n    BASEGEOGCRS[\"SVY21\",\n        DATUM[\"SVY21\",\n            ELLIPSOID[\"WGS 84\",6378137,298.257223563,\n                LENGTHUNIT[\"metre\",1]]],\n        PRIMEM[\"Greenwich\",0,\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n        ID[\"EPSG\",4757]],\n    CONVERSION[\"Singapore Transverse Mercator\",\n        METHOD[\"Transverse Mercator\",\n            ID[\"EPSG\",9807]],\n        PARAMETER[\"Latitude of natural origin\",1.36666666666667,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8801]],\n        PARAMETER[\"Longitude of natural origin\",103.833333333333,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8802]],\n        PARAMETER[\"Scale factor at natural origin\",1,\n            SCALEUNIT[\"unity\",1],\n            ID[\"EPSG\",8805]],\n        PARAMETER[\"False easting\",28001.642,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8806]],\n        PARAMETER[\"False northing\",38744.572,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8807]]],\n    CS[Cartesian,2],\n        AXIS[\"northing (N)\",north,\n            ORDER[1],\n            LENGTHUNIT[\"metre\",1]],\n        AXIS[\"easting (E)\",east,\n            ORDER[2],\n            LENGTHUNIT[\"metre\",1]],\n    USAGE[\n        SCOPE[\"Cadastre, engineering survey, topographic mapping.\"],\n        AREA[\"Singapore - onshore and offshore.\"],\n        BBOX[1.13,103.59,1.47,104.07]],\n    ID[\"EPSG\",3414]]\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n\n## Singapore Master Plan 2019 Subzone Boundary\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nmpsz <-st_read(dsn = \"data/spatial\",\n               layer = \"MPSZ-2019\") %>% \n  st_transform(crs = 3414)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `MPSZ-2019' from data source \n  `C:\\sihuihui\\mitbcapstone\\notebooks\\data\\spatial' using driver `ESRI Shapefile'\nSimple feature collection with 332 features and 6 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 103.6057 ymin: 1.158699 xmax: 104.0885 ymax: 1.470775\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nst_crs(mpsz)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCoordinate Reference System:\n  User input: EPSG:3414 \n  wkt:\nPROJCRS[\"SVY21 / Singapore TM\",\n    BASEGEOGCRS[\"SVY21\",\n        DATUM[\"SVY21\",\n            ELLIPSOID[\"WGS 84\",6378137,298.257223563,\n                LENGTHUNIT[\"metre\",1]]],\n        PRIMEM[\"Greenwich\",0,\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n        ID[\"EPSG\",4757]],\n    CONVERSION[\"Singapore Transverse Mercator\",\n        METHOD[\"Transverse Mercator\",\n            ID[\"EPSG\",9807]],\n        PARAMETER[\"Latitude of natural origin\",1.36666666666667,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8801]],\n        PARAMETER[\"Longitude of natural origin\",103.833333333333,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8802]],\n        PARAMETER[\"Scale factor at natural origin\",1,\n            SCALEUNIT[\"unity\",1],\n            ID[\"EPSG\",8805]],\n        PARAMETER[\"False easting\",28001.642,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8806]],\n        PARAMETER[\"False northing\",38744.572,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8807]]],\n    CS[Cartesian,2],\n        AXIS[\"northing (N)\",north,\n            ORDER[1],\n            LENGTHUNIT[\"metre\",1]],\n        AXIS[\"easting (E)\",east,\n            ORDER[2],\n            LENGTHUNIT[\"metre\",1]],\n    USAGE[\n        SCOPE[\"Cadastre, engineering survey, topographic mapping.\"],\n        AREA[\"Singapore - onshore and offshore.\"],\n        BBOX[1.13,103.59,1.47,104.07]],\n    ID[\"EPSG\",3414]]\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ntmap_options(check.and.fix = TRUE)\ntm_shape(mpsz) +\n  tm_polygons(\"lightgreen\", title = \"Singapore Boundary\") +\n  tm_layout(main.title = \"Singapore Master Plan 2019 Subzone Boundary\",\n            main.title.position = \"center\",\n            main.title.size = 1.0,\n            legend.height = 0.35, \n            legend.width = 0.35,\n            frame = TRUE) +\n  tm_compass(type=\"8star\", size = 2) +\n  tm_scale_bar() +\n  tm_grid(alpha = 0.2)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: The shape mpsz is invalid. See sf::st_is_valid\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](edsa-business2_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n# creating the Hexagon Layer \n\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nhex_layer <- st_make_grid(mpsz,\n               cellsize = 400,\n               what = \"polygon\",\n               square = FALSE) %>%\n  st_sf() \n\nhex_layer\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 13685 features and 0 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 2267.538 ymin: 15517.78 xmax: 56667.54 ymax: 50620.68\nProjected CRS: SVY21 / Singapore TM\nFirst 10 features:\n                         geometry\n1  POLYGON ((2467.538 15864.19...\n2  POLYGON ((2467.538 16557.01...\n3  POLYGON ((2467.538 17249.83...\n4  POLYGON ((2467.538 17942.65...\n5  POLYGON ((2467.538 18635.47...\n6  POLYGON ((2467.538 19328.29...\n7  POLYGON ((2467.538 20021.11...\n8  POLYGON ((2467.538 20713.93...\n9  POLYGON ((2467.538 21406.75...\n10 POLYGON ((2467.538 22099.57...\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ntm_shape(hex_layer) +\n  tm_fill(col = \"white\", title = \"Hexagons\") +\n  tm_borders(alpha = 0.5) +\n  tm_layout(main.title = \"Singapore with hex grid\",\n            main.title.position = \"center\",\n            main.title.size = 1.0,\n            legend.height = 0.35, \n            legend.width = 0.35,\n            frame = TRUE) +\n  tm_compass(type=\"8star\", size = 2, bg.color = \"white\", bg.alpha = 0.5) +\n  tm_scale_bar(bg.color = \"white\", bg.alpha = 0.5) +\n  tm_shape(mpsz) +\n  tm_fill(\"forestgreen\", title = \"Singapore Boundary\", alpha = 0.5) +\n  tm_shape(business_sf) +\n  tm_dots(col = \"blue\", size = 0.005, title = \"Business\")\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: The shape mpsz is invalid. See sf::st_is_valid\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](edsa-business2_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n\n## Giving each hexagon an ID \n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nhex_layer$HEX_ID <- sprintf(\"H%04d\", seq_len(nrow(hex_layer))) %>% as.factor()\nhead(hex_layer)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 6 features and 1 field\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 2267.538 ymin: 15864.19 xmax: 2667.538 ymax: 19790.17\nProjected CRS: SVY21 / Singapore TM\n                        geometry HEX_ID\n1 POLYGON ((2467.538 15864.19...  H0001\n2 POLYGON ((2467.538 16557.01...  H0002\n3 POLYGON ((2467.538 17249.83...  H0003\n4 POLYGON ((2467.538 17942.65...  H0004\n5 POLYGON ((2467.538 18635.47...  H0005\n6 POLYGON ((2467.538 19328.29...  H0006\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n\n\n## Number of businesses in each hexagon \n\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nhex_layer$`BIZ_COUNT`<- lengths(st_intersects(hex_layer, business_sf))\n```\n:::\n\n\n\n\n\n\n\n\n\n\n\n## Hexagons only with businesses \n\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nbiz_hex <- filter(hex_layer, BIZ_COUNT >0)\nbiz_hex\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 2709 features and 2 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 3067.538 ymin: 22792.39 xmax: 53467.54 ymax: 50274.27\nProjected CRS: SVY21 / Singapore TM\nFirst 10 features:\n                         geometry HEX_ID BIZ_COUNT\n1  POLYGON ((3267.538 24870.86...  H0216        33\n2  POLYGON ((4267.538 27988.55...  H0473         1\n3  POLYGON ((4267.538 28681.37...  H0474         9\n4  POLYGON ((4467.538 28334.96...  H0524         4\n5  POLYGON ((4467.538 29720.6,...  H0526       108\n6  POLYGON ((4467.538 30413.42...  H0527        12\n7  POLYGON ((4667.538 27295.73...  H0573         6\n8  POLYGON ((4667.538 30067.01...  H0577       106\n9  POLYGON ((4667.538 30759.83...  H0578        19\n10 POLYGON ((4667.538 31452.65...  H0579         2\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ntm_shape(mpsz) +\n  tm_fill(\"forestgreen\", title = \"Singapore Boundary\", alpha = 0.5) +\n  tm_shape(biz_hex) +\n  tm_fill(col = \"white\", title = \"Hexagons\", alpha = 1) +\n  tm_borders(alpha = 0.2) +\n  tm_layout(main.title = \"Honeycomb grid corresponding to Singapore bus stops\",\n            main.title.position = \"center\",\n            main.title.size = 1.0,\n            legend.height = 0.35, \n            legend.width = 0.35,\n            frame = TRUE) +\n  tm_compass(type=\"8star\", size = 2, bg.color = \"white\", bg.alpha = 0.5) +\n  tm_scale_bar(bg.color = \"white\", bg.alpha = 0.5) +\n  tm_shape(business_sf) +\n  tm_dots(col = \"blue\", size = 0.001, title = \"Bus Stops\") +\n  tm_grid(alpha = 0.2)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: The shape mpsz is invalid. See sf::st_is_valid\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](edsa-business2_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n\n\n\n\n# Is there any signs of spatial clustering? \n\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nknn6_nb <- biz_hex %>% st_centroid() %>% st_knn(k=6)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: st_centroid assumes attributes are constant over geometries\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nhead(knn6_nb, n = 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[[1]]\n[1]  2  7 18 19 26 39\n\n[[2]]\n[1]  3  4  7 12 19 27\n\n[[3]]\n[1]  2  4 12 19 20 27\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nbiz_knn6 <- biz_hex %>%\n  mutate(\n    nb = knn6_nb,\n    wt = st_inverse_distance(nb, geometry,\n                             scale = 1,\n                             alpha = 1)\n  )\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n! Polygon provided. Using point on surface.\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n\n\n## Global Measure of Spatial Autocorrelation \n\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nglobal_moran_perm(\n  biz_knn6$BIZ_COUNT,\n  biz_knn6$nb,\n  biz_knn6$wt,\n  nsim = 99\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tMonte-Carlo simulation of Moran I\n\ndata:  x \nweights: listw  \nnumber of simulations + 1: 100 \n\nstatistic = 0.48945, observed rank = 100, p-value < 2.2e-16\nalternative hypothesis: two.sided\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n\nI is 0.48945, which is more than 0, showing signs of clustering \n\n## Local  Measure of Spatial Autocorrelation \n\n### Calculating Local Moran's I \n\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nlmi_biz <- biz_knn6 %>% \n  mutate(local_moran = local_moran(\n    BIZ_COUNT, nb, wt, nsim = 99),\n         .before = 1) %>%\n  unnest(local_moran)\n```\n:::\n\n\n\n\n\n\n\n\n\n\n### Plotting Local Moran's I and p-value \n\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n tmap_arrange(\n    tm_shape(mpsz) +\n      tm_fill(col=\"green\") +\n      tm_borders(alpha = 0.5) +\n      tm_shape(lmi_biz) +\n      tm_polygons(\"ii\"),\n    tm_shape(mpsz) +\n      tm_fill(col=\"green\") +\n      tm_borders(alpha = 0.5) +\n      tm_shape(lmi_biz) +\n      tm_polygons(\"p_ii_sim\",\n              breaks = c(0, 0.001, 0.01, 0.05, 1),\n              labels = c(\"0.001\", \"0.01\", \"0.05\", \"Not sig\"),\n              palette = \"YlOrRd\"\n              ),\n    ncol = 2\n  )\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: The shape mpsz is invalid. See sf::st_is_valid\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nVariable(s) \"ii\" contains positive and negative values, so midpoint is set to 0. Set midpoint = NA to show the full spectrum of the color palette.\n```\n\n\n:::\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: The shape mpsz is invalid. See sf::st_is_valid\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](edsa-business2_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n\n\n### Plotting LISA Map \n\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ntm_shape(mpsz) +\n  tm_fill(col=\"white\")+\n  tm_borders(alpha = 0.5) +\n  tm_shape(lmi_biz %>% filter(p_ii_sim < 0.05)) +\n  tm_polygons(\"mean\") + \n  tm_layout(\n    main.title = \"LISA for Businesses\",\n    main.title.position = \"center\",\n    main.title.size = 1\n  )\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: The shape mpsz is invalid. See sf::st_is_valid\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](edsa-business2_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "edsa-business2_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}