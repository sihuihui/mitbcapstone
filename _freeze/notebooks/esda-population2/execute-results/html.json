{
  "hash": "d75cd44da2875775781051ec5a91d313",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"ESDA - Population\"\nauthor: \"Goh Si Hui\"\ndate: \"Oct 27 2024\"\ndate-modified: \"last-modified\"\nexecute: \n  eval: true\n  echo: true\n  message: false\n  warning: false\n  freeze: true\n  code-line-numbers: true\n---\n\n\n\n\n\n\n\n\n\n\n# Setting the environment \n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\npacman::p_load(tidyverse, purrr, sf, tmap, sfdep)\n```\n:::\n\n\n\n\n\n\n\n\n\n\n# Importing Datasets \n\n## Business data \n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nrespop <- read_rds(\"data/rds/res_coords.rds\")\nglimpse(respop)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 10,489\nColumns: 5\n$ address              <chr> \"1 BEACH RD\", \"1 BEDOK STH AVE 1\", \"1 CHAI CHEE R…\n$ total_dwelling_units <dbl> 142, 206, 102, 55, 96, 125, 247, 95, 220, 219, 31…\n$ postal               <chr> \"190001\", \"460001\", \"461001\", \"500001\", \"160001\",…\n$ latitude             <chr> \"1.3036713506088\", \"1.32085208689731\", \"1.3279687…\n$ longitude            <chr> \"103.864478660925\", \"103.933721091441\", \"103.9227…\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n\nconvert to sf \n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nrespop_sf <- st_as_sf(respop, \n                       coords = c(\"longitude\", \"latitude\"),\n                       crs=4326) %>%\n  st_transform(crs = 3414)\n\nglimpse(respop_sf)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nRows: 10,489\nColumns: 4\n$ address              <chr> \"1 BEACH RD\", \"1 BEDOK STH AVE 1\", \"1 CHAI CHEE R…\n$ total_dwelling_units <dbl> 142, 206, 102, 55, 96, 125, 247, 95, 220, 219, 31…\n$ postal               <chr> \"190001\", \"460001\", \"461001\", \"500001\", \"160001\",…\n$ geometry             <POINT [m]> POINT (31467.83 31778.89), POINT (39173.81 …\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ndwelling <- respop_sf %>%\n  group_by(postal) %>%\n  summarise (TOTAL_DWELLING = sum(total_dwelling_units))\n```\n:::\n\n\n\n\n\n\n\n\n\n\n\n\n## Singapore Master Plan 2019 Subzone Boundary\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nmpsz <-st_read(dsn = \"data/spatial\",\n               layer = \"MPSZ-2019\") %>% \n  st_transform(crs = 3414)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nReading layer `MPSZ-2019' from data source \n  `C:\\sihuihui\\mitbcapstone\\notebooks\\data\\spatial' using driver `ESRI Shapefile'\nSimple feature collection with 332 features and 6 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: 103.6057 ymin: 1.158699 xmax: 104.0885 ymax: 1.470775\nGeodetic CRS:  WGS 84\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nst_crs(mpsz)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCoordinate Reference System:\n  User input: EPSG:3414 \n  wkt:\nPROJCRS[\"SVY21 / Singapore TM\",\n    BASEGEOGCRS[\"SVY21\",\n        DATUM[\"SVY21\",\n            ELLIPSOID[\"WGS 84\",6378137,298.257223563,\n                LENGTHUNIT[\"metre\",1]]],\n        PRIMEM[\"Greenwich\",0,\n            ANGLEUNIT[\"degree\",0.0174532925199433]],\n        ID[\"EPSG\",4757]],\n    CONVERSION[\"Singapore Transverse Mercator\",\n        METHOD[\"Transverse Mercator\",\n            ID[\"EPSG\",9807]],\n        PARAMETER[\"Latitude of natural origin\",1.36666666666667,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8801]],\n        PARAMETER[\"Longitude of natural origin\",103.833333333333,\n            ANGLEUNIT[\"degree\",0.0174532925199433],\n            ID[\"EPSG\",8802]],\n        PARAMETER[\"Scale factor at natural origin\",1,\n            SCALEUNIT[\"unity\",1],\n            ID[\"EPSG\",8805]],\n        PARAMETER[\"False easting\",28001.642,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8806]],\n        PARAMETER[\"False northing\",38744.572,\n            LENGTHUNIT[\"metre\",1],\n            ID[\"EPSG\",8807]]],\n    CS[Cartesian,2],\n        AXIS[\"northing (N)\",north,\n            ORDER[1],\n            LENGTHUNIT[\"metre\",1]],\n        AXIS[\"easting (E)\",east,\n            ORDER[2],\n            LENGTHUNIT[\"metre\",1]],\n    USAGE[\n        SCOPE[\"Cadastre, engineering survey, topographic mapping.\"],\n        AREA[\"Singapore - onshore and offshore.\"],\n        BBOX[1.13,103.59,1.47,104.07]],\n    ID[\"EPSG\",3414]]\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n  tm_shape(mpsz) +\n  tm_fill(\"forestgreen\", title = \"Singapore Boundary\", alpha = 0.5) +\n  tm_shape(respop_sf) +\n  tm_dots(col = \"blue\", size = 0.005, title = \"Business\")\n```\n\n::: {.cell-output-display}\n![](esda-population2_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n\n# Creating the Hexagon Layer \n\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nhex_layer <- st_make_grid(mpsz,\n               cellsize = 400,\n               what = \"polygon\",\n               square = FALSE) %>%\n  st_sf() \n\nhex_layer\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 13685 features and 0 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 2267.538 ymin: 15517.78 xmax: 56667.54 ymax: 50620.68\nProjected CRS: SVY21 / Singapore TM\nFirst 10 features:\n                         geometry\n1  POLYGON ((2467.538 15864.19...\n2  POLYGON ((2467.538 16557.01...\n3  POLYGON ((2467.538 17249.83...\n4  POLYGON ((2467.538 17942.65...\n5  POLYGON ((2467.538 18635.47...\n6  POLYGON ((2467.538 19328.29...\n7  POLYGON ((2467.538 20021.11...\n8  POLYGON ((2467.538 20713.93...\n9  POLYGON ((2467.538 21406.75...\n10 POLYGON ((2467.538 22099.57...\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ntm_shape(hex_layer) +\n  tm_fill(col = \"white\", title = \"Hexagons\") +\n  tm_borders(alpha = 0.5) +\n  tm_layout(main.title = \"Singapore with hex grid\",\n            main.title.position = \"center\",\n            main.title.size = 1.0,\n            legend.height = 0.35, \n            legend.width = 0.35,\n            frame = TRUE) +\n  tm_compass(type=\"8star\", size = 2, bg.color = \"white\", bg.alpha = 0.5) +\n  tm_scale_bar(bg.color = \"white\", bg.alpha = 0.5) +\n  tm_shape(mpsz) +\n  tm_fill(\"forestgreen\", title = \"Singapore Boundary\", alpha = 0.5) +\n  tm_shape(respop_sf) +\n  tm_dots(col = \"blue\", size = 0.005, title = \"Business\")\n```\n\n::: {.cell-output-display}\n![](esda-population2_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n\n## Giving each hexagon an ID \n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nhex_layer$HEX_ID <- sprintf(\"H%04d\", seq_len(nrow(hex_layer))) %>% as.factor()\nhead(hex_layer)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 6 features and 1 field\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 2267.538 ymin: 15864.19 xmax: 2667.538 ymax: 19790.17\nProjected CRS: SVY21 / Singapore TM\n                        geometry HEX_ID\n1 POLYGON ((2467.538 15864.19...  H0001\n2 POLYGON ((2467.538 16557.01...  H0002\n3 POLYGON ((2467.538 17249.83...  H0003\n4 POLYGON ((2467.538 17942.65...  H0004\n5 POLYGON ((2467.538 18635.47...  H0005\n6 POLYGON ((2467.538 19328.29...  H0006\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n\n\n## Count of HDB blocks in each hexagon \n\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nhex_layer$'HDB_COUNT' <- lengths(st_intersects(hex_layer, respop_sf))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nres_hex <- filter(hex_layer, HDB_COUNT > 0)\nres_hex\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 1030 features and 2 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 11267.54 ymin: 27642.14 xmax: 45467.54 ymax: 48888.63\nProjected CRS: SVY21 / Singapore TM\nFirst 10 features:\n                         geometry HEX_ID HDB_COUNT\n1  POLYGON ((11467.54 35609.57...  H2302         7\n2  POLYGON ((11667.54 35263.16...  H2352         1\n3  POLYGON ((11667.54 35955.98...  H2353         3\n4  POLYGON ((11867.54 35609.57...  H2403        21\n5  POLYGON ((12067.54 35955.98...  H2454        19\n6  POLYGON ((12267.54 34916.75...  H2503         1\n7  POLYGON ((12267.54 35609.57...  H2504         7\n8  POLYGON ((12267.54 36302.39...  H2505        11\n9  POLYGON ((12467.54 35263.16...  H2554        12\n10 POLYGON ((12467.54 35955.98...  H2555        22\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ntm_shape(mpsz) +\n  tm_fill(\"forestgreen\", title = \"Singapore Boundary\", alpha = 0.5) +\n  tm_shape(res_hex) +\n  tm_fill(col = \"white\", title = \"Hexagons\", alpha = 1) +\n  tm_borders(alpha = 0.2) +\n  tm_layout(main.title = \"Hexagon grid corresponding to HDB Residential Estates\",\n            main.title.position = \"center\",\n            main.title.size = 1.0,\n            legend.height = 0.35, \n            legend.width = 0.35,\n            frame = TRUE) +\n  tm_compass(type=\"8star\", size = 2, bg.color = \"white\", bg.alpha = 0.5) +\n  tm_scale_bar(bg.color = \"white\", bg.alpha = 0.5) +\n  tm_shape(respop_sf) +\n  tm_dots(col = \"blue\", size = 0.001, title = \"Bus Stops\") +\n  tm_grid(alpha = 0.2)\n```\n\n::: {.cell-output-display}\n![](esda-population2_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n\n\n\n## Sum of Dwellings in each hexagon \n\nFirst find out which blocks are in which hexagon \n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nres_hex <- st_intersection(respop_sf, hex_layer) %>%\n  st_drop_geometry() %>%\n  select(c(postal,total_dwelling_units, HEX_ID))\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: attribute variables are assumed to be spatially constant throughout\nall geometries\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nhead(res_hex)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 3\n  postal total_dwelling_units HEX_ID\n  <chr>                 <dbl> <fct> \n1 640903                   84 H2302 \n2 640904                  110 H2302 \n3 640905                   28 H2302 \n4 640906                   90 H2302 \n5 640907                   77 H2302 \n6 640908                  110 H2302 \n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n\n\nAggregate by hexagon \n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ndwelling_hex <- res_hex %>%\n  group_by(HEX_ID) %>%\n  summarise(TOTAL_DWELLING = sum(total_dwelling_units))\n\nhead(dwelling_hex)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 × 2\n  HEX_ID TOTAL_DWELLING\n  <fct>           <dbl>\n1 H10029            736\n2 H10030            267\n3 H10031            944\n4 H10032           1206\n5 H10033           1147\n6 H10034           1053\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n\n\n## Hexagons only with dwelling\n\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nhex_layer <- left_join(hex_layer, dwelling_hex, by = join_by(HEX_ID))\nhead(hex_layer)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 6 features and 3 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 2267.538 ymin: 15864.19 xmax: 2667.538 ymax: 19790.17\nProjected CRS: SVY21 / Singapore TM\n  HEX_ID HDB_COUNT TOTAL_DWELLING                       geometry\n1  H0001         0             NA POLYGON ((2467.538 15864.19...\n2  H0002         0             NA POLYGON ((2467.538 16557.01...\n3  H0003         0             NA POLYGON ((2467.538 17249.83...\n4  H0004         0             NA POLYGON ((2467.538 17942.65...\n5  H0005         0             NA POLYGON ((2467.538 18635.47...\n6  H0006         0             NA POLYGON ((2467.538 19328.29...\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ndwell_hex <- filter(hex_layer, TOTAL_DWELLING > 0)\ndwell_hex\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSimple feature collection with 1030 features and 3 fields\nGeometry type: POLYGON\nDimension:     XY\nBounding box:  xmin: 11267.54 ymin: 27642.14 xmax: 45467.54 ymax: 48888.63\nProjected CRS: SVY21 / Singapore TM\nFirst 10 features:\n   HEX_ID HDB_COUNT TOTAL_DWELLING                       geometry\n1   H2302         7            609 POLYGON ((11467.54 35609.57...\n2   H2352         1             96 POLYGON ((11667.54 35263.16...\n3   H2353         3            175 POLYGON ((11667.54 35955.98...\n4   H2403        21           1996 POLYGON ((11867.54 35609.57...\n5   H2454        19           1691 POLYGON ((12067.54 35955.98...\n6   H2503         1            153 POLYGON ((12267.54 34916.75...\n7   H2504         7            790 POLYGON ((12267.54 35609.57...\n8   H2505        11            873 POLYGON ((12267.54 36302.39...\n9   H2554        12           1243 POLYGON ((12467.54 35263.16...\n10  H2555        22           1511 POLYGON ((12467.54 35955.98...\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ntm_shape(mpsz) +\n  tm_fill(\"forestgreen\", title = \"Singapore Boundary\", alpha = 0.5) +\n  tm_shape(dwell_hex) +\n  tm_fill(\"TOTAL_DWELLING\",\n          style = \"quantile\",\n          palette = \"Blues\",\n          title = \"Total Dwelling\") +\n  tm_borders(alpha = 0.2) +\n  tm_layout(main.title = \"HDB Dwelling\",\n            main.title.position = \"center\",\n            main.title.size = 1.0,\n            legend.height = 0.35, \n            legend.width = 0.35,\n            frame = TRUE) +\n  tm_compass(type=\"8star\", size = 2, bg.color = \"white\", bg.alpha = 0.5) +\n  tm_scale_bar(bg.color = \"white\", bg.alpha = 0.5) \n```\n\n::: {.cell-output-display}\n![](esda-population2_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n\n\n# Is there any signs of spatial clustering? \n\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nknn6_nb <- dwell_hex %>% st_centroid() %>% st_knn(k=6)\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nWarning: st_centroid assumes attributes are constant over geometries\n```\n\n\n:::\n\n```{.r .cell-code .hidden}\nhead(knn6_nb, n = 3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[[1]]\n[1]  2  3  4  5  7 10\n\n[[2]]\n[1] 1 3 4 5 6 7\n\n[[3]]\n[1] 1 2 4 5 7 8\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ndwell_knn6 <- dwell_hex %>%\n  mutate(\n    nb = knn6_nb,\n    wt = st_inverse_distance(nb, geometry,\n                             scale = 1,\n                             alpha = 1)\n  )\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\n! Polygon provided. Using point on surface.\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n\n\n## Global Measure of Spatial Autocorrelation \n\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nglobal_moran_perm(\n  dwell_knn6$TOTAL_DWELLING,\n  dwell_knn6$nb,\n  dwell_knn6$wt,\n  nsim = 99\n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\n\tMonte-Carlo simulation of Moran I\n\ndata:  x \nweights: listw  \nnumber of simulations + 1: 100 \n\nstatistic = 0.14372, observed rank = 100, p-value < 2.2e-16\nalternative hypothesis: two.sided\n```\n\n\n:::\n:::\n\n\n\n\n\n\n\n\n\nI is 0.14372, which is more than 0, showing signs of clustering \n\n## Local  Measure of Spatial Autocorrelation \n\n### Calculating Local Moran's I \n\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\nlmi_dwell <- dwell_knn6 %>% \n  mutate(local_moran = local_moran(\n    TOTAL_DWELLING, nb, wt, nsim = 99),\n         .before = 1) %>%\n  unnest(local_moran)\n```\n:::\n\n\n\n\n\n\n\n\n\n\n### Plotting Local Moran's I and p-value \n\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\n tmap_arrange(\n    tm_shape(mpsz) +\n      tm_fill(col=\"green\") +\n      tm_borders(alpha = 0.5) +\n      tm_shape(lmi_dwell) +\n      tm_polygons(\"ii\"),\n    tm_shape(mpsz) +\n      tm_fill(col=\"green\") +\n      tm_borders(alpha = 0.5) +\n      tm_shape(lmi_dwell) +\n      tm_polygons(\"p_ii_sim\",\n              breaks = c(0, 0.001, 0.01, 0.05, 1),\n              labels = c(\"0.001\", \"0.01\", \"0.05\", \"Not sig\"),\n              palette = \"YlOrRd\"\n              ),\n    ncol = 2\n  )\n```\n\n::: {.cell-output .cell-output-stderr .hidden}\n\n```\nVariable(s) \"ii\" contains positive and negative values, so midpoint is set to 0. Set midpoint = NA to show the full spectrum of the color palette.\n```\n\n\n:::\n\n::: {.cell-output-display}\n![](esda-population2_files/figure-html/unnamed-chunk-23-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n\n### Plotting LISA Map \n\n\n\n\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code .hidden}\ntm_shape(mpsz) +\n  tm_fill(col=\"white\")+\n  tm_borders(alpha = 0.5) +\n  tm_shape(lmi_dwell %>% filter(p_ii_sim < 0.05)) +\n  tm_polygons(\"mean\") + \n  tm_layout(\n    main.title = \"LISA for HDB Residences\",\n    main.title.position = \"center\",\n    main.title.size = 1\n  )\n```\n\n::: {.cell-output-display}\n![](esda-population2_files/figure-html/unnamed-chunk-24-1.png){width=672}\n:::\n:::",
    "supporting": [
      "esda-population2_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}